# Moshi Server Reverse Proxy Configuration
# See docs/REVERSE_PROXY_SETUP.md for details
{
	email {$CADDY_ADMIN_EMAIL:grantfullenjr@gmail.com}
}

(transcribe_upstream) {
	reverse_proxy {$TRANSCRIBE_UPSTREAM:http://127.0.0.1:3000} {
		header_up Host {upstream_hostport}
	}
}

(transcribe_ws_upstream) {
	reverse_proxy {$TRANSCRIBE_UPSTREAM:http://127.0.0.1:3000} {
		header_up Host {upstream_hostport}
		header_up Connection {http.request.header.Connection}
		header_up Upgrade {http.request.header.Upgrade}
	}
}

transcribe.fullen.dev {

	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		Referrer-Policy "same-origin"
		X-Content-Type-Options "nosniff"
	}

	@websocket {
		header Connection *Upgrade*
		header Upgrade websocket
	}

	handle @websocket {
		import transcribe_ws_upstream
	}

	handle {
		import transcribe_upstream
	}
}

stt.fullen.dev {
	# Better Auth server routes (if auth-server is running on port 3001)
	# Uncomment the following block to enable auth server routing:
	# handle /api/auth/* {
	# 	reverse_proxy localhost:3001
	# }
	# handle /health {
	# 	reverse_proxy localhost:3001
	# }

	# All other routes go to moshi-server
	# This includes:
	# 	- /api/chat (WebSocket - ASR streaming)
	# 	- /api/asr (WebSocket - ASR streaming, dynamic path)
	# 	- /api/tts (POST - TTS)
	# 	- /api/tts_streaming (WebSocket - TTS streaming)
	# 	- /api/build_info (GET - build info)
	# 	- /api/modules_info (GET - modules info)
	# 	- /metrics (GET - Prometheus metrics)
	# 	- /* (Static files - client app)
	reverse_proxy 127.0.0.1:8080 {
		# Let Caddy handle WebSocket upgrade automatically (don't override headers)
		
		# WebSocket streaming: disable buffering
		flush_interval -1
		
		# Robust stream timeout (1 hour) to prevent disconnects
		stream_timeout 3600s
		
		# Explicit transport timeouts
		transport http {
			read_timeout 3600s
			write_timeout 3600s
		}
	}
}
